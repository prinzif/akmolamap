<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ–±—ã—Ç–∏–π - –ê–∫–º–æ–ª–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</title>

  <!-- Favicon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üó∫Ô∏è</text></svg>">

  <!-- Leaflet ‚Äî –≥—Ä—É–∑–∏–º –ü–ï–†–í–´–ú, –±–µ–∑ defer -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ ‚Äî –±–µ–∑ defer -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  
  <!-- Leaflet –ø–ª–∞–≥–∏–Ω—ã (–≤—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–µ) -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet-textpath@1.2.3/leaflet.textpath.min.js" defer></script>

  <!-- –ü–æ—Å—Ç-–ø—Ä–æ–≤–µ—Ä–∫–∞ Leaflet + ¬´–ø–∏–Ω¬ª API –¥–ª—è –º–æ–¥—É–ª–µ–π -->
  <script>
    (function(){
      const ok = !!(window.L && L.Map && L.Control && L.tileLayer && L.markerClusterGroup);
      console.log('Leaflet ready?', ok, 'version:', window.L && L.version);
      if (!ok) {
        throw new Error('Leaflet failed to initialize');
      }
      // –ü—Ä–∏—à–ø–∏–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª –Ω–∞ –æ–∫–Ω–µ
      window.__Leaflet = window.L;
    })();
  </script>

  <!-- –ù–∞—à–∏ —Å—Ç–∏–ª–∏ -->
  <link rel="stylesheet" href="assets/styles.css" />
</head>

<body data-bbox="65.0,49.5,76.0,54.0"
      data-gadm-l1="/assets/gadm41_KAZ_1.json"
      data-gadm-l2="/assets/gadm41_KAZ_2.json"
      data-header-url="/header">
  <noscript>–î–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Ç—Ä–µ–±—É–µ—Ç—Å—è JavaScript.</noscript>

  <!-- Header (–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏) -->
  <header id="site-header" role="banner" aria-label="–®–∞–ø–∫–∞ —Å–∞–π—Ç–∞"></header>

  <!-- Main -->
  <div class="container">
    <aside class="sidebar">
      <section class="sidebar-section">
        <h3>üìç –°–æ–±—ã—Ç–∏—è –≤ –ê–∫–º–æ–ª–∏–Ω—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏</h3>
        <p style="font-size: 13px; color: #666; margin-bottom: 12px;">
          –ü—Ä–∏—Ä–æ–¥–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –∏ —è–≤–ª–µ–Ω–∏—è –Ω–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ —Ä–µ–≥–∏–æ–Ω–∞ –ø–æ –¥–∞–Ω–Ω—ã–º NASA EONET
        </p>
        <div class="date-filters">
          <label>üìÖ –ü–µ—Ä–∏–æ–¥:</label>
          <input type="date" id="date-from">
          <input type="date" id="date-to">
        </div>
        <div class="controls">
          <button id="refresh-data" type="button">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
          <button id="apply-date" type="button">üìÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</button>
        </div>

        <div style="margin: 16px 0; padding: 10px; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; font-size: 12px;">
          <strong>‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</strong><br>
          –û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —Ä–µ–≥–∏–æ–Ω–∞ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.
        </div>

        <h4 style="margin-top: 16px; font-size: 14px;">üîç –§–∏–ª—å—Ç—Ä—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h4>
        <div class="controls">
          <button id="select-all" type="button">‚úì –í—Å–µ</button>
          <button id="deselect-all" type="button">‚úó –°–Ω—è—Ç—å</button>
        </div>
        <div id="category-filters"></div>
      </section>

      <section class="sidebar-section">
        <h3>üìã –°–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π</h3>
        <input type="text" class="search-box" id="search-events" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é‚Ä¶" style="margin-bottom: 12px;">
        <div id="event-list"></div>
      </section>

      <section class="sidebar-section">
        <h3>üìä –õ–µ–≥–µ–Ω–¥–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π</h3>
        <div class="legend" id="legend"></div>
      </section>
    </aside>

    <main class="main-content">
      <div class="loading-overlay" id="loading" aria-hidden="true">
        <div class="spinner" role="status" aria-label="–ó–∞–≥—Ä—É–∑–∫–∞"></div>
      </div>
      <div id="map" role="region" aria-label="–ö–∞—Ä—Ç–∞ —Ä–µ–≥–∏–æ–Ω–∞"></div>
      <div id="summary" class="summary"></div>
    </main>
  </div>

  <!-- –õ–æ–∫–∞–ª—å–Ω–∞—è —Å–±–æ—Ä–∫–∞ osmtogeojson -->
  <script src="/assets/vendor/osmtogeojson.js"></script>
  <script>
    // –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
    console.log('osmtogeojson global =',
      typeof ((window.osmtogeojson && (window.osmtogeojson.default || window.osmtogeojson)) || window.osmToGeoJSON)
    );
  </script>

  <!-- App -->
  <script src="assets/app.js"></script>

  <!-- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ö–µ–¥–µ—Ä -->
  <script>
    (function () {
      async function mountHeader() {
        const url = document.body?.dataset?.headerUrl || '/header';
        try {
          const resp = await fetch(url, { cache: 'no-cache' });
          if (!resp.ok) throw new Error('Header HTTP ' + resp.status + ' (' + url + ')');
          const html = await resp.text();

          const el = document.getElementById('site-header');
          if (!el) throw new Error('#site-header not found');

          el.innerHTML = html;

          // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º <script> —Ç–µ–≥–∏
          el.querySelectorAll('script').forEach(old => {
            const s = document.createElement('script');
            [...old.attributes].forEach(a => s.setAttribute(a.name, a.value));
            if (old.src) { s.async = false; } else { s.textContent = old.textContent || ''; }
            old.replaceWith(s);
          });

          // –ò–∑–º–µ—Ä—è–µ–º —Ä–µ–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É header –∏ –æ–±–Ω–æ–≤–ª—è–µ–º CSS-–ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
          requestAnimationFrame(() => {
            // Header –º–æ–Ω—Ç–∏—Ä—É–µ—Ç #__hdr –≤–Ω—É—Ç—Ä—å #site-header, –∏–∑–º–µ—Ä—è–µ–º –µ–≥–æ
            const hdrEl = el.querySelector('#__hdr') || el.querySelector('.header') || el;
            const h = hdrEl.offsetHeight || 64;
            document.documentElement.style.setProperty('--header-h', h + 'px');
            console.log('‚úÖ Header height set to:', h + 'px');
          });

          // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç—É –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ header
          setTimeout(() => {
            if (window.app?.map) {
              window.app.map.invalidateSize();
            }
          }, 100);

          initHeaderInteractions?.();
          highlightActiveLink?.();
          updateStatusBadge?.();
          wireHeaderButtons?.();
        } catch (e) {
          console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å header:', e);
          const el = document.getElementById('site-header');
          if (el && !el.innerHTML.trim()) {
            el.innerHTML = '<div class="alert warning">–•–µ–¥–µ—Ä –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è</div>';
          }
        }
      }

      function highlightActiveLink() {
        const current = location.pathname.replace(/\/+$/, '/') || '/';
        document.querySelectorAll('#site-header .nav-link[href], #site-header .dropdown-item[href]').forEach(a => {
          const href = new URL(a.href, location.origin).pathname.replace(/\/+$/, '/') || '/';
          if (href === current) a.classList.add('active');
        });
      }

      function initHeaderInteractions() {
        document.querySelectorAll('#site-header .nav-item.has-dropdown > .nav-link').forEach(btn => {
          btn.addEventListener('click', () => {
            const expanded = btn.getAttribute('aria-expanded') === 'true';
            btn.setAttribute('aria-expanded', String(!expanded));
            btn.parentElement.classList.toggle('open', !expanded);
          });
          btn.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); btn.click(); }
          });
        });
      }

      function updateStatusBadge() {
        const badge = document.querySelector('#site-header #status-badge');
        if (!badge) return;
        fetch('/api/v1/settings/health')
          .then(r => r.json())
          .then(data => {
            if (data.ok) { badge.textContent = '–û–Ω–ª–∞–π–Ω'; badge.className = 'status-badge'; }
            else if (data.cdse_ok) { badge.textContent = '–ß–∞—Å—Ç–∏—á–Ω–æ'; badge.className = 'status-badge warning'; }
            else { badge.textContent = '–û—à–∏–±–∫–∞'; badge.className = 'status-badge error'; }
          })
          .catch(() => { badge.textContent = '–û—Ñ—Ñ–ª–∞–π–Ω'; badge.className = 'status-badge error'; });
      }

      function wireHeaderButtons() {
        document.querySelector('#site-header #btn-refresh')?.addEventListener('click', () => location.reload());
      }

      function wireSidebar() {
        document.getElementById('refresh-data')?.addEventListener('click', () => window.app?.loadEvents?.());
        const from = document.getElementById('date-from');
        const to = document.getElementById('date-to');
        if (from && !from.value) from.value = '2024-05-01';
        if (to && !to.value) to.value = '2024-09-30';
      }

      document.addEventListener('DOMContentLoaded', () => {
        mountHeader();
        wireSidebar();
      });
    })();
  </script>
</body>
</html>